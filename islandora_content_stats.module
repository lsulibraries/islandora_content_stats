<?php
/**
 * Implements hook_menu().
 */
function islandora_content_stats_menu() {
  $items = array();
  $items['admin/islandora/tools/content_stats'] = array(
    'title' => 'Content Statistics',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('islandora_content_stats_admin_form',1),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/admin.form.inc',
  );
  $items['data'] = array(
    'title' => 'Content Statistics',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('islandora_content_stats_form', 1),
    'access arguments' => array('administer site configuration'),
    'access callback' => TRUE,
    'file' => 'includes/data.form.inc',
  );
  $items['data/download'] = array( //data
    'title' => t('Download Content Stats to CSV'),
    'page callback' => 'islandora_content_stats_csv_download',
    'access callback' => TRUE,
    );
  return $items;
}

function islandora_content_stats_csv_download(){
  module_load_include('inc', 'islandora_content_stats', '/includes/utilities');
  $query = "SELECT * FROM ldl.islandora_content_stats";
  $filters = [];
  foreach($_GET as $key => $filter){
    if($filter != 'data/download'){
      $filters[$key] = $filter;
    }
  }
  //if requesting historic data
  if(isset($filters['all'])){
  if($filters['all'] == 1){
    array_pop($filters);
    foreach($filters as $key => $filter){
      if($key == 'inst' || $key == 'cmodel' || $key == 'coll'){
        if(strpos($query,'WHERE') === FALSE){
          if($filter !=''){
              $query .= ' WHERE '.$key.' = \''.$filter.'\'';
          }
        }
        else{
          if($filter !=''){
              $query .= ' AND '.$key.' = \''.$filter.'\'';
          }
        }
      }
    }
  }
  //when requesting latest data
  else{
    $max_time = '';
    $q_time = db_query('select MAX(timestamp) from ldl.islandora_content_stats');
    $max_time = $q_time->fetchField();
    $query .= " WHERE timestamp = ".'\''.$max_time.'\'';
    array_pop($filters);
    foreach($filters as $key => $filter){
      if($filter != ''){
        $query .= ' AND '.$key.' = \''.$filter.'\'';
      }
    }
  }
}
  $results = db_query($query) or die ("Sql error : ".mysql_error());
  drupal_add_http_header("Content-type", "text/csv; utf-8");
  drupal_add_http_header("Content-Disposition", "attachment; filename=islandora_content_stats.csv");
  $fh = fopen('php://output','w');
  foreach($results as $result){
    if( $result->cmodel == 'fedora-system:FedoraObject-3.0' || $result->cmodel == 'fedora-system:ContentModel-3.0' || $result->coll == 'islandora:root'){}
    else{
      fputcsv($fh,array($result->id,map_institution($result->inst),map_collection($result->coll),map_cmodels($result->cmodel),$result->count,strftime('%d:%m:%Y:%r' , $result->timestamp ),map_collection($result->coll,'csv')));
    }
  }
}

//path testing...WIP
// foreach(arg() as $arg){
//   if(count(arg()) == 1){
//     if($arg == ''){
//       dpm('arg is empty str');
//       dpm(arg());
//     }
//     elseif(strlen($arg) < 10 && strlen($arg) > 1 && $arg != 'issues'){
//       dpm('could be institution');
//     }
//     else{
//       dpm(arg());
//     }
//   }
//   elseif($arg == 'islandora' || $arg == 'collection' || $arg =='object'){
//   }
// }

/**
 * Implements hook_cron().
 * must stay in .module file
 * If cron is running and the date, and hour match, execute queries
 */
function islandora_content_stats_cron() {
  module_load_include('inc','islandora_content_stats','includes/queries');
  $date = variable_get('islandora_content_stats_query_run_date');
  //$day  = variable_get('islandora_content_stats_query_run_day');
  $hour = variable_get('islandora_content_stats_query_run_hour');
  if(date('G')==intval($hour) && date('d')==$date){ //&& date('l')==$day
    islandora_content_stats_run_queries();
  }
}

/**
* Implements hook_block_info().
*/
function islandora_content_stats_block_info() {
  $blocks = array();
  $blocks['mini'] = array(
    'info' => t('Content Stats Mini'),
    'status' => 0, //change to 1 to enable block.
    'region' => 'content',
    'visibility' => BLOCK_VISIBILITY_NOTLISTED,
    'pages' => '',
  );
  return $blocks;
}

function islandora_content_stats_block_view($delta = ''){
  module_load_include('inc','islandora_content_stats','includes/block.form');
  $blocks = array();
  module_load_include('php','islandora_namespace_homepage','includes/namespaces');
  $frontpage = drupal_is_front_page();
  $instpage = '';
  $ns_prefix = update_namespace_prefixes_cache();
  foreach($ns_prefix as $prefix){
    if(request_uri() == '/'.$prefix){
      $instpage = TRUE;
    }
  }
  $collpage = strpos(request_uri(), 'collection');
  if($frontpage || $instpage || $collpage){
        $blocks['subject'] = t('Content Models');
        $blocks['content'] = drupal_get_form('islandora_content_stats_mini_form');
      }
  return $blocks;
}
