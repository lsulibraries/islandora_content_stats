<?php
require_once dirname(__FILE__) . '/includes/queries.inc';
require_once dirname(__FILE__) . '/includes/reports.form.inc';
require_once dirname(__FILE__) . '/includes/reports-page.form.inc';
module_load_include('php','islandora_namespace_homepage','includes/utilities;');

/**
 * Implements hook_menu().
 */
function islandora_content_stats_menu() {
  $items = array();
  $items['admin/islandora/tools/content_stats'] = array(
    'title' => 'Content Statistics Admin',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('islandora_content_stats_admin_form',1),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/admin.form.inc',
  );
  $items['admin/reports/content_stats'] = array(
    'title' => 'Content Statistics',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('islandora_content_stats_recent_form', 1),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/reports.form.inc',
  );
  $items['admin/reports/content_stats/data'] = array( //data
    'title' => t('Download Content Stats to CSV'),
    'page callback' => 'islandora_content_stats_csv_download', //drupal_get_form?
    'access arguments' =>  array('administer site configuration'), //needed?
    //'type' => MENU_NORMAL_ITEM,
    //'file' => 'includes/reports.form.inc'
    );
  return $items;
}

function islandora_content_stats_csv_download(){
  $query = "SELECT * FROM ldl.islandora_content_stats";
  $filters = [];
  foreach($_GET as $key => $filter){
    if($filter != 'admin/reports/content_stats/data'){
      $filters[$key] = $filter;
    }
  }
  //if coming from all queries page
  if(in_array('all', $filters)){
    array_pop($filters);
    foreach($filters as $key => $filter){
      if($key == 'inst' || $key == 'cmodel' || $key == 'coll'){
        if(!strpos($query,'WHERE')){
          $query .= ' WHERE '.$key.' LIKE \'%'.$filter.'%\'';
        }
        else{
          $query .= ' AND '.$key.' LIKE \'%'.$filter.'%\'';
        }
      }
    }
  }
  //when on 'latest queries' page add timestamp
  else{
    $max_time = '';
    $q_time = db_query('select MAX(timestamp) from ldl.islandora_content_stats');
    foreach($q_time as $return){
      foreach($return as $key => $value){
          $max_time = $value;
      }
    }
    $query .= " WHERE timestamp = ".$max_time;
    foreach($filters as $key => $filter){
      $query .= ' AND '.$key.' LIKE \'%'.$filter.'%\'';
    }
  }
  $results = db_query($query) or die ("Sql error : ".mysql_error());
  drupal_add_http_header("Content-type", "text/csv; utf-8");
  drupal_add_http_header("Content-Disposition", "attachment; filename=islandora_content_stats.csv");
  $fh = fopen('php://output','w');
  foreach($results as $result){
    if(strpos($result->cmodel,'fedora-system:FedoraObject-3.0') || strpos($result->cmodel,'fedora-system:ContentModel-3.0')){}
    else{
      fputcsv($fh,array($result->id,map_institution($result->inst),map_collection($result->coll),map_cmodels($result->cmodel),$result->count,strftime('%d:%m:%Y:%r' , $result->timestamp ),map_collection($result->coll,'csv')));
    }
  }
  //drupal_goto('data/',$filters);
}

/**
* Implements hook_block_info().
*/
function islandora_content_stats_block_info() {
  $blocks = array();
    $blocks['content_stats'] = array(
      'info' => t('Content Stats'),
      'cache' => DRUPAL_NO_CACHE,
    );
    $blocks['content_stats_page'] = array(
      'info' => t('Content Stats Page Content Models'),
      'status' => 0, //change to 1
      'region' => 'content',

      'visibility' => BLOCK_VISIBILITY_PHP,
      'pages' =>"<?php  if (  (arg(0) == 'node' && arg(1) == '' ) || (strlen(arg(0)) < 10 && strlen(arg(0)) > 1 && count(arg()) == 1 && arg(0) != 'issues') || ( arg(0) == 'islandora' && strpos(arg(2),'collection') && count(arg()) < 4  ) ){return true;} return false; ?>",
    );
  return $blocks;
}

function islandora_content_stats_block_view($delta = ''){
$blocks = array();
  switch ($delta) {
    case 'content_stats':
      $blocks['subject'] = t('Content Stats Block');
      $blocks['content'] = drupal_get_form('islandora_content_stats_recent_form');
      break;
    case 'content_stats_page':
        $blocks['subject'] = t('Content Stats Page Content Models');
        $blocks['content'] = drupal_get_form('islandora_content_stats_table_page_form');
        break;
  }
  return $blocks;
}
