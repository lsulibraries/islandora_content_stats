<?php

/**
 * Implements hook_menu().
 */

function islandora_content_stats_menu() {
  $items = array();
  $items['admin/islandora/tools/content_stats'] = array(
    'title' => 'Content Statistics',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('islandora_content_stats_admin_form', 1),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/admin.form.inc',
  );
  $items['data'] = array(
    'title' => 'Content Statistics',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('islandora_content_stats_form', 1),
    'access arguments' => array('administer site configuration'),
    'access callback' => TRUE,
    'file' => 'includes/data.form.inc',
  );
  $items['data/download'] = array( //data
    'title' => t('Download Content Stats to CSV'),
    'page callback' => 'islandora_content_stats_csv_download',
    'access callback' => TRUE,
    );
  return $items;
}

/**
 * Download function
 * applies filters to queries and returns as csv file
 */

function islandora_content_stats_csv_download() {
  module_load_include('inc', 'islandora_content_stats', '/includes/utilities');
  $query = 'SELECT * FROM islandora_content_stats';
  $filters = array();
  foreach($_GET as $key => $filter) {
    if ($filter != 'data/download') {
      $filters[$key] = $filter;
    }
  }
  //if requesting historic data
  if (isset($filters['all'])) {
    if ($filters['all'] == 1) {
      array_pop($filters);
      foreach($filters as $key => $filter) {
        if ($key == 'cmodel' || $key == 'coll') {
          if (strpos($query, 'WHERE') === FALSE) {
            if ($filter !='') {
              $query .= ' WHERE ' . $key . ' = \'' . $filter . '\'';
            }
          }
          else{
            if ($filter != '') {
              $query .= ' AND ' . $key . ' = \'' . $filter . '\'';
            }
          }
        }
      }
    }
  //when requesting latest data
    else{
      $max_time = '';
      $q_time = db_query('select MAX(timestamp) from islandora_content_stats');
      $max_time = $q_time->fetchField();
      $query .= ' WHERE timestamp = \'' . $max_time . '\'';
      array_pop($filters);
      foreach($filters as $key => $filter) {
        if ($filter != '') {
          $query .= ' AND ' . $key . ' = \'' . $filter . '\'';
        }
      }
    }
  }
  $results = db_query($query) or die ('Sql error : ' . mysql_error());
  drupal_add_http_header('Content-type', 'text/csv; utf-8');
  $attach_str = 'attachment; filename=islandora_content_stats.csv';
  drupal_add_http_header('Content-Disposition', $attach_str);
  $fh = fopen('php://output', 'w');
  foreach($results as $result) {
    $not_fobj = $result->cmodel != 'fedora-system:FedoraObject-3.0';
    $not_cmobj = $result->cmodel != 'fedora-system:ContentModel-3.0';
    $not_rootcoll = $result->coll != 'islandora:root';
    if ( ($not_fobj) && ($not_cmobj) && ($not_rootcoll) ) {
      $mapped_results = array(
        $result->id,
        map_collection($result->coll),
        map_cmodels($result->cmodel),
        $result->count,
        strftime('%d:%m:%Y:%r', $result->timestamp),
        map_collection($result->coll, 'csv')
      );
      fputcsv($fh, $mapped_results);
    }
  }
}

/**
 * Implements hook_cron().
 * must stay in .module file
 * If cron is running and the date, and hour match, execute queries
 */

function islandora_content_stats_cron() {
  module_load_include('inc', 'islandora_content_stats', 'includes/queries');
  $date = variable_get('islandora_content_stats_query_run_date');
  //$day  = variable_get('islandora_content_stats_query_run_day');
  $hour = variable_get('islandora_content_stats_query_run_hour');
  // && date('l') == $day // add back below if day is specified
  if (date('G') == intval($hour) && date('d') == $date) {
    islandora_content_stats_run_queries();
  }
}

/**
 * Implements hook_block_info().
 * Displays cmodel count on content region
 * at islandora:root it shows totals sitewide
 * at a given collection it shows totals for that collection
 */

function islandora_content_stats_block_info() {
  $blocks = array();
  $blocks['mini'] = array(
    'info' => t('Content Stats Mini'),
    'status' => 0, //change to 1 to enable block.
    'region' => 'content',
    'visibility' => BLOCK_VISIBILITY_NOTLISTED,
    'pages' => '',
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 * Logic for which totals to display in block.
 */
function islandora_content_stats_block_view() {
  module_load_include('inc', 'islandora_content_stats', 'includes/block.form');
  $blocks = array();
  $frontpage = drupal_is_front_page();
  $collpage = strpos(request_uri(), 'collection');
  if ($frontpage || $collpage) {
    $blocks['subject'] = t('Content Models');
    $blocks['content'] = drupal_get_form('islandora_content_stats_mini_form');
  }
  return $blocks;
}
